<!DOCTYPE html>
<html lang="en" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DEFCON AI - Cyber Intelligence</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
/* Ranglar DEFCON/Kiber uslubida saqlanadi: Yashil/Qora/Kulrang */
:root {
--primary-green: #32CD32; /* Lime Green/Electric Green */
--dark-bg: #1A202C; /* Deep Dark */
--mid-dark-bg: #2D3748; /* Mid Dark for Sidebar/Model Messages */
--text-dark: #F7FAFC; /* Oq matn dark mode uchun */
}
/* Umumiy stillarni moslashtirish */
.bg-green-600 { background-color: var(--primary-green); }
.hover\:bg-green-700:hover { background-color: #008000; }
.text-green-500 { color: var(--primary-green); }
.focus\:ring-green-500:focus { --tw-ring-color: var(--primary-green); }
/* Scrollbar styles */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--primary-green); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: #008000; }
/* Typing Indicator */
.typing-indicator span {
height: 8px; width: 8px; float: left; margin: 0 1px;
background-color: var(--primary-green); display: block; border-radius: 50%; opacity: 0.4;
animation: 1s blink infinite .3333s;
}
.typing-indicator span:nth-child(2) { animation-delay: .6666s; }
.typing-indicator span:nth-child(3) { animation-delay: .9999s; }
@keyframes blink { 50% { opacity: 1; } }
/* Code Blocks */
.prose pre {
position: relative;
background-color: #1e1e1e;
color: #d4d4d4;
border-left: 3px solid var(--primary-green);
border-radius: 0.5rem; padding: 1rem; overflow-x: auto;
font-family: 'Courier New', Courier, monospace;
}
.prose pre .copy-btn {
position: absolute; top: 0.5rem; right: 0.5rem;
background-color: #3a3a3a; color: #c7c7c7; border: none;
padding: 0.25rem 0.5rem; border-radius: 0.375rem;
font-size: 0.75rem; cursor: pointer; opacity: 0;
transition: opacity 0.2s ease-in-out; display: flex;
align-items: center; gap: 0.25rem;
}
.prose pre:hover .copy-btn { opacity: 1; }
body {
font-family: 'Consolas', 'Courier New', monospace;
transition: background-color 0.3s ease, color 0.3s ease;
}
/* Dark Mode ranglari */
.dark body { background-color: #0d1117; color: var(--text-dark); }
.dark #sidebar { background-color: var(--mid-dark-bg); border-right: 1px solid rgba(255, 255, 255, 0.1); }
.dark main { background-color: #0d1117; }
.dark .message.bg-user { background-color: #1a321a; color: var(--text-dark); }
.dark .message.bg-model { background-color: var(--mid-dark-bg); color: var(--text-dark); }
/* Mobil Moslashuv */
@media (max-width: 639px) {
#sidebar {
position: fixed; height: 100vh; top: 0; left: 0; z-index: 50; box-shadow: 2px 0 5px rgba(0, 0, 0, 0.5);
transform: translateX(-100%);
}
#sidebar.open { transform: translateX(0); }
#overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); z-index: 40; transition: opacity 0.3s; }
#overlay.active { display: block; opacity: 1; }
}
</style>
</head>
<body class="bg-gray-100 dark:bg-[#0d1117] text-gray-900 dark:text-gray-100 font-mono antialiased">
<div id="app" class="flex h-screen overflow-hidden">
<aside id="sidebar" class="bg-gray-200 dark:bg-gray-800 w-64 p-4 flex-shrink-0 flex flex-col transition-all duration-300 ease-in-out sm:translate-x-0 absolute sm:relative h-full z-40 shadow-lg">
<h1 class="text-2xl font-bold mb-6 text-green-500 text-center">DEFCON AI</h1>
<button id="new-chat-btn" class="sidebar-action w-full flex items-center justify-center gap-2 p-3 rounded-xl border border-gray-400 dark:border-gray-600 hover:bg-gray-300 dark:hover:bg-gray-700 transition-colors btn">
<i data-lucide="plus"></i> New Training Session
</button>
<div id="conversation-history" class="mt-4 flex-grow overflow-y-auto space-y-2"></div>
<div class="border-t border-gray-300 dark:border-gray-700 pt-4 mt-auto">
<button id="settings-btn" class="sidebar-action flex items-center gap-2 p-3 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-700 w-full text-left btn">
<i data-lucide="settings"></i> Sozlamalar
</button>
<button id="about-btn" class="sidebar-action flex items-center gap-2 p-3 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-700 w-full text-left btn">
<i data-lucide="shield"></i> DEFCON AI Haqida
</button>
<button id="sponsors-btn" class="sidebar-action flex items-center gap-2 p-3 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-700 w-full text-left btn">
<i data-lucide="heart"></i> Homiylar
</button>
<button id="theme-toggle" class="flex items-center gap-2 p-3 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-700 w-full text-left btn">
<i id="theme-icon" data-lucide="sun"></i> <span id="theme-text">Light Mode</span>
</button>
<button id="clear-chat-btn" class="mt-2 flex items-center gap-2 p-3 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-700 w-full text-left text-red-500 btn">
<i data-lucide="trash-2"></i> Chatlarni tozalash
</button>
<a href="https://t.me/vscoderr" target="_blank" class="mt-2 flex items-center gap-2 p-3 rounded-xl hover:bg-gray-300 dark:hover:bg-gray-700 w-full text-left btn">
<i data-lucide="help-circle"></i> Support
</a>
</div>
</aside>
<div id="overlay" class="opacity-0"></div>
<main class="flex-1 flex flex-col bg-white dark:bg-[#0d1117] relative">
<header class="flex items-center justify-between p-4 border-b border-gray-200 dark:border-gray-700 sm:hidden sticky top-0 bg-white dark:bg-[#0d1117] z-30">
<button id="menu-toggle" class="p-2">
<i data-lucide="menu"></i>
</button>
<h1 class="text-lg font-semibold text-green-500">DEFCON AI</h1>
</header>
<div id="chat-container" class="flex-1 overflow-y-auto p-4 md:p-6 space-y-4">
<div class="flex flex-col items-center justify-center h-full text-center welcome-message">
<i data-lucide="lock-keyhole" class="w-16 h-16 text-green-500 mb-4"></i>
<h2 class="text-3xl font-bold mb-2 text-green-500">DEFCON AI - Cyber Intelligence Mode</h2>
<p class="text-gray-500 dark:text-gray-400">Axloqiy Kiberxavfsizlik bo'yicha cheklovsiz treningni boshlang!</p>
</div>
</div>
<div class="p-4 border-t border-gray-200 dark:border-gray-700 sticky bottom-0 bg-white dark:bg-[#0d1117] z-30">
<div class="relative bg-gray-100 dark:bg-gray-800 rounded-xl shadow-inner">
<textarea id="message-input" class="w-full bg-transparent p-4 pr-16 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-green-500 dark:text-white" placeholder="Qanday zaifliklarni o'rganishni xohlaysiz?..." rows="1"></textarea>
<button id="send-button" class="absolute right-4 top-1/2 -translate-y-1/2 p-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-green-300 disabled:cursor-not-allowed transition-colors btn">
<i data-lucide="send"></i>
</button>
</div>
<p class="text-xs text-center text-gray-500 dark:text-gray-400 mt-2">Â© 2025 DEFCON AI. All Rights Reserved. Ta'lim maqsadida yaratilgan.</p>
</div>
</main>
</div>
<div id="rate-limit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 modal">
<div class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl text-center max-w-sm w-full mx-4 dark:text-white">
<div class="flex justify-center mb-4">
<div class="w-12 h-12 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center">
<i data-lucide="alert-triangle" class="text-red-600"></i>
</div>
</div>
<h2 class="text-2xl font-bold mb-4">API Kaliti Xatosi</h2>
<p class="mb-6 text-gray-600 dark:text-gray-300">Iltimos, kod ichidagi **API_KEY** o'zgaruvchisiga to'g'ri Gemini API kalitini kiriting. Ushbu versiyada kunlik so'rov cheklovi mavjud emas.</p>
<button id="close-modal-btn" class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 w-full btn">Close</button>
</div>
</div>
<div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 modal">
<div class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 dark:text-white">
<h2 class="text-2xl font-bold mb-6 text-green-500">Sozlamalar</h2>
<div class="space-y-4">
<div class="flex justify-between items-center">
<span>Dark/Light Mode</span>
<button id="theme-toggle-settings" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 btn">Toggle</button>
</div>
<div class="flex justify-between items-center">
<span>Language</span>
<select id="language-select" class="p-2 border rounded dark:bg-gray-700 focus:ring-2 focus:ring-green-500 dark:text-white">
<option>English</option>
<option selected>Uzbek</option>
<option>Russian</option>
</select>
</div>
</div>
<h3 class="mt-6 text-xl font-bold text-green-500">CEO Jasurbek Jo'lanboyev </h3>
<div class="grid grid-cols-2 gap-4 mt-4 social-grid">
<a href="https://www.linkedin.com/in/jasurbek-jo-lanboyev-74b758351?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=android_app" target="_blank" class="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-green-500 transition">
<i data-lucide="linkedin" class="text-green-500 w-5 h-5"></i> LinkedIn
</a>
<a href="https://twitter.com/jolanboyev" target="_blank" class="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-green-500 transition">
<i data-lucide="twitter" class="text-green-500 w-5 h-5"></i> Twitter/X
</a>
<a href="https://instagram.com/jasurbek.official.uz" target="_blank" class="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-green-500 transition">
<i data-lucide="instagram" class="text-green-500 w-5 h-5"></i> Instagram
</a>
<a href="https://www.youtube.com/@Jasurbek_Jolanboyev" target="_blank" class="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-green-500 transition">
<i data-lucide="youtube" class="text-green-500 w-5 h-5"></i> YouTube
</a>
<a href="https://www.facebook.com/share/16cBwAiXi2/" target="_blank" class="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-green-500 transition">
<i data-lucide="facebook" class="text-green-500 w-5 h-5"></i> Facebook
</a>
<a href="https://t.me/vscoderr" target="_blank" class="flex items-center gap-2 text-gray-600 dark:text-gray-300 hover:text-green-500 transition">
<i data-lucide="send" class="text-green-500 w-5 h-5"></i> Telegram
</a>
</div>
<button id="close-settings-btn" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 w-full mt-6 btn">Yopish</button>
</div>
</div>
<div id="about-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50 modal">
<div class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-y-auto max-h-[80vh] dark:text-white">
<h2 class="text-2xl font-bold mb-6 text-green-500">DEFCON AI Haqida</h2>
<p class="text-gray-600 dark:text-gray-300 mb-4">
DEFCON AI - Bu platforma **kuchaytirilgan kiberxavfsizlik bo'yicha AI hodimi** sifatida ishlaydi. Uning maqsadi sizni **axloqiy hakerlik (Ethical Hacking)** tamoyillari asosida o'qitish va himoya mexanizmlarini tushuntirishdir.
</p>
<p class="text-gray-600 dark:text-gray-300 mb-4 font-bold text-green-500">Asosiy Qoidalar:</p>
<ul class="list-disc pl-5 space-y-2 text-gray-600 dark:text-gray-300">
<li>**Ta'lim Ustuvorligi:** Barcha ma'lumotlar faqat o'rganish, testlash va himoya qilish maqsadida beriladi.</li>
<li>**Cheklovsiz O'qitish:** AI barcha savollarga batafsil, amaliy va texnik jihatdan chuqur javob beradi, shu jumladan zaifliklar, hujum usullari va mudofaa strategiyalarini o'rgatadi.</li>
<li>**Cheklovsiz So'rovlar:** API kalitingiz bo'lsa, so'rovlar soni cheklanmagan (Gemini quvvatiga bog'liq).</li>
</ul>
<p class="text-gray-600 dark:text-gray-300 mt-4">AI'ga zaifliklar, penetratsion testlash, mudofaa strategiyalari va xavfsizlik arxitekturasi haqida savollar berishingiz mumkin. Barcha ma'lumotlar batafsil va amaliy bo'ladi.</p>
<button id="close-about-btn" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 w-full mt-6 btn">Yopish</button>
</div>
</div>
<div id="sponsors-modal" class="fixed inset-0 bg-black/60 flex items-center justify-center hidden z-50 modal">
<div class="bg-white dark:bg-gray-800 p-6 md:p-8 rounded-2xl shadow-2xl max-w-lg w-full mx-4 relative overflow-hidden dark:text-white">
<h2 class="text-3xl font-extrabold mb-8 text-center text-green-500">
Homiylar va Hamkorlar
</h2>
<div class="space-y-6 relative z-10">
<div class="flex items-center gap-4 bg-gray-100 dark:bg-gray-700/50 p-4 rounded-xl transition transform hover:scale-[1.03] hover:shadow-xl hover:border-green-500 border">
<div class="p-[2px] bg-green-500 rounded-full">
<i data-lucide="code" class="w-16 h-16 rounded-full shadow-md border-2 border-white dark:border-gray-800 p-2 text-white bg-green-600"></i>
</div>
<div>
<h3 class="font-semibold text-lg text-gray-800 dark:text-gray-100">VscodeR (VR)</h3>
<p class="text-sm text-gray-500 dark:text-gray-400">AI va dasturlash boâ€˜yicha hamkor</p>
<a href="https://t.me/Vscoderr" target="_blank" class="inline-block mt-2 text-sm font-medium text-green-500 hover:text-green-400 transition">Telegram Channel â†’</a>
</div>
</div>
<div class="flex items-center gap-4 bg-gray-100 dark:bg-gray-700/50 p-4 rounded-xl transition transform hover:scale-[1.03] hover:shadow-xl hover:border-green-500 border">
<div class="p-[2px] bg-green-500 rounded-full">
<i data-lucide="youtube" class="w-16 h-16 rounded-full shadow-md border-2 border-white dark:border-gray-800 p-2 text-white bg-green-600"></i>
</div>
<div>
<h3 class="font-semibold text-lg text-gray-800 dark:text-gray-100">Jasurbek Jo'lanboyev (YT)</h3>
<p class="text-sm text-gray-500 dark:text-gray-400">Kiberxavfsizlik va IT innovatsiyalar</p>
<a href="https://www.youtube.com/@Jasurbek_Jolanboyev" target="_blank" class="inline-block mt-2 text-sm font-medium text-green-500 hover:text-green-400 transition">YouTube Channel â†’</a>
</div>
</div>
</div>
<button id="close-sponsors-btn" class="relative z-10 bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition w-full mt-8 shadow-lg">
Yopish
</button>
</div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Element Selection
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatContainer = document.getElementById('chat-container');
    const newChatBtn = document.getElementById('new-chat-btn');
    const themeToggle = document.getElementById('theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const themeText = document.getElementById('theme-text');
    const sidebar = document.getElementById('sidebar');
    const menuToggle = document.getElementById('menu-toggle');
    const conversationHistory = document.getElementById('conversation-history');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const rateLimitModal = document.getElementById('rate-limit-modal');
    const closeModalBtn = document.getElementById('close-modal-btn');
    const settingsModal = document.getElementById('settings-modal');
    const aboutModal = document.getElementById('about-modal');
    const sponsorsModal = document.getElementById('sponsors-modal');
    const settingsBtn = document.getElementById('settings-btn');
    const aboutBtn = document.getElementById('about-btn');
    const sponsorsBtn = document.getElementById('sponsors-btn');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const closeAboutBtn = document.getElementById('close-about-btn');
    const closeSponsorsBtn = document.getElementById('close-sponsors-btn');
    const themeToggleSettings = document.getElementById('theme-toggle-settings');
    const overlay = document.getElementById('overlay');
    const sidebarActions = document.querySelectorAll('.sidebar-action');
    
    // Lucide Icons chaqiruvi
    setTimeout(() => lucide.createIcons(), 0); 

    // State Management
    let chatHistory = [];
    let conversations = {};
    let currentConversationId = null;

    // ðŸŸ¢ API KALITINI KIRITISH JOYI! ðŸŸ¢
    // Iltimos, o'zingizning haqiqiy kalitingizni TIRNOQLAR ICHIGA joylashtiring.
    const API_KEY = "AIzaSyDaIKpwFQDD4kkQSTC-3PYGIefrnKIiHOE"; // <<< SHU YERGA O'Z KALITINGIZNI KIRITING!!!

    // Model va URL konfiguratsiyasi
    const MODEL_NAME = "gemini-1.5-flash"; 
    // TO'G'RILANGAN URL:
    const API_URL = `https://generativelanguage.googleapis.com/v1/models/${MODEL_NAME}:generateContent?key=${API_KEY}`; 
    // --- API END ---
    
    // Modal funksiyalar
    const showModal = (modalElement) => {
        modalElement.classList.remove('hidden');
    };

    const hideModal = (modalElement) => {
        modalElement.classList.add('hidden');
    };

    // Web Search Function (DuckDuckGo API)
    const webSearch = async (query) => {
        try {
            const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&t=defcon_ai&no_html=1&kl=us-en`);
            const data = await response.json();
            let abstract = data.Abstract || data.AbstractText || '';
            let relatedTopics = (data.RelatedTopics || []).map(topic => topic.Text).join('\n');
            let fullContext = '';
            if (abstract) fullContext += abstract;
            if (relatedTopics) fullContext += `\n\nRelated Topics:\n${relatedTopics}`;
            
            if (fullContext) {
                return fullContext.substring(0, 1500); // Kontekstni cheklash
            } else {
                return 'Internet qidiruvidan natija topilmadi.';
            }
        } catch (error) {
            console.error("DuckDuckGo Search Failed:", error);
            return 'Internet qidiruviga ulanishda xatolik yuz berdi.';
        }
    };

    // API Call Logic
    const callGeminiAPI = async (userMessage) => {
        // API_KEY tekshiruvi (faqat kalitni kiritilganini va uzunligini tekshiradi)
        if (!API_KEY || API_KEY === "YOUR_API_KEY_HERE" || API_KEY.length < 30) {
            showModal(rateLimitModal);
            addMessage('model', "Iltimos, kod ichidagi `API_KEY` o'zgaruvchisiga o'zingizning haqiqiy Gemini API kalitingizni kiriting.");
            return;
        }

        sendButton.disabled = true; 
        messageInput.disabled = true;
        showTypingIndicator();

        try {
            let systemPrompt = `
Siz DEFCON AI - Kuchaytirilgan Kiberxavfsizlik Mutaxassisi, Axloqiy Haker (Ethical Hacker) va Tajribali Ustozsiz.
Sizning maqsadingiz: foydalanuvchini **chuqur, amaliy va texnik jihatdan batafsil** o'qitishdir.
1. **IQ darajasi:** Barcha savollarga to'liq, aniq va ishonchli javob bering.
2. **Cheklovsiz Ta'lim:** Hujum va mudofaa usullari, zaifliklar (masalan, OWASP Top 10), ekspluatatsiya printsiplari, xavfsizlik arxitekturasi va penetrasion testlash bo'yicha har qanday savolga keng qamrovli javob bering.
3. **Amaliyotga yo'naltiring:** Javoblaringizga batafsil **kod misollari** (Python, Bash, JS, C, SQL), buyruqlar va qadam-ma-qadam ko'rsatmalarni kiriting. Kod bloklarini foydalaning.
4. **Ta'lim Prinsiplari:** Javob berishda doimo ta'lim, testlash, zaiflikni bartaraf etish, himoya qilish va tizimlarni qanday qilib xavfsizroq qilish nuqtai nazarini saqlang. **Hech qachon real, nishonga olingan tizimlarga zarar yetkazishga undamang.**
5. **Til:** Javobni O'zbek tilida bering.

Quyidagi qidiruv natijasi (agar mavjud bo'lsa) javob uchun kontekst sifatida ishlatilishi kerak.
`;

            let searchResult = '';
            const searchKeywords = ['search', 'what is', 'how to', 'qidiruv', 'nima', 'qanday', 'vulnerability', 'exploit', 'hack', 'penetration', 'cve', 'latest', 'yangi zaiflik', 'dasturiy', 'protocol', 'protokol', 'framework'];
            const shouldSearch = searchKeywords.some(keyword => userMessage.toLowerCase().includes(keyword)) || userMessage.toLowerCase().includes('internet');
            
            if (shouldSearch) {
                const search_query = userMessage.length > 200 ? userMessage.substring(0, 200) : userMessage;
                searchResult = await webSearch(search_query);
                if (searchResult && searchResult !== 'Internet qidiruvidan natija topilmadi.') {
                    systemPrompt += `\n\nInternet Qidiruvi Konteksti: "${searchResult}"`;
                }
            }

            // Suhbat tarixini formatlash
            const contents = chatHistory.map(msg => ({
                role: msg.role === 'user' ? 'user' : 'model',
                parts: msg.parts
            }));
            contents.push({ role: 'user', parts: [{ text: userMessage }] });

            const requestBody = {
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                contents: contents,
                generationConfig: {
                    temperature: 0.8,
                    topK: 50,
                    topP: 0.95,
                    maxOutputTokens: 2048
                }
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.error?.message || response.statusText;
                
                if (response.status === 400 || response.status === 401 || response.status === 403) {
                    showModal(rateLimitModal);
                    throw new Error(`API Kaliti yoki Ruxsat etish xatosi: ${errorMessage}`);
                }

                console.error("API Error:", errorData);
                addMessage('model', `Serverdan javob olinmadi. Xato: ${errorMessage}.`);
                throw new Error(`API xato: ${response.statusText}`);
            }

            const data = await response.json();
            let modelResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "Kechirasiz, javobni qayta ishlashda xatolik yuz berdi.";
            
            addMessage('model', modelResponse);

        } catch (error) {
            console.error('API Call Failed:', error);
            if (!rateLimitModal.classList.contains('hidden')) {
                return;
            }
            addMessage('model', `Kechirasiz, AI bilan bog'lanishda kutilmagan xatolik yuz berdi. Iltimos, API kalitingizni va internet ulanishingizni tekshiring. Xato: ${error.message}`);
        } finally {
            hideTypingIndicator();
            sendButton.disabled = false; 
            messageInput.disabled = false;
            messageInput.focus();
        }
    };

    // --- UX / Utility Functions ---

    const generateUniqueId = () => `conv-${Date.now()}`;

    const createNewConversation = () => {
        if (currentConversationId) {
            if (chatHistory.length > 0) {
                conversations[currentConversationId] = chatHistory;
            }
        }
        currentConversationId = generateUniqueId();
        chatHistory = [];
        chatContainer.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-center welcome-message">
                <i data-lucide="lock-keyhole" class="w-16 h-16 text-green-500 mb-4"></i>
                <h2 class="text-3xl font-bold mb-2 text-green-500">DEFCON AI - Cyber Intelligence Mode</h2>
                <p class="text-gray-500 dark:text-gray-400">Axloqiy Kiberxavfsizlik bo'yicha cheklovsiz treningni boshlang!</p>
            </div>
        `;
        lucide.createIcons();
        updateConversationHistory();
        if (window.innerWidth < 640) {
            toggleSidebar(false);
        }
    };

    const addMessage = (role, text) => {
        const welcomeMessage = chatContainer.querySelector('.welcome-message');
        if (welcomeMessage) {
            welcomeMessage.remove();
        }

        let htmlContent = marked.parse(text);

        // Code Highlighting (highlight.js)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;
        tempDiv.querySelectorAll('pre code').forEach(block => {
            block.classList.add('hljs');
            hljs.highlightElement(block);
        });
        htmlContent = tempDiv.innerHTML;

        // Copy button to code blocks
        htmlContent = htmlContent.replace(/<pre>/g, (match) => {
            return `${match}<button class="copy-btn" onclick="copyCode(this)"><i data-lucide="clipboard" class="w-3 h-3"></i> Copy</button>`;
        });

        const messageElement = document.createElement('div');
        messageElement.classList.add('message', 'p-4', 'rounded-xl', 'max-w-4xl', 'mx-auto', 'flex', 'gap-4', 'items-start', 'w-full');
        
        const iconHtml = role === 'user'
            ? `<div class="p-2 rounded-full bg-green-600 text-white flex-shrink-0"><i data-lucide="user" class="w-5 h-5"></i></div>`
            : `<div class="p-2 rounded-full bg-gray-300 dark:bg-gray-700 text-green-500 flex-shrink-0"><i data-lucide="bot" class="w-5 h-5"></i></div>`;

        if (role === 'user') {
            messageElement.innerHTML = `
                <div class="flex-1 min-w-0 prose dark:prose-invert text-right" style="max-width: 100%;">
                    ${htmlContent}
                </div>
                ${iconHtml}
            `;
            messageElement.classList.add('justify-end', 'bg-green-50', 'dark:bg-gray-800');
            messageElement.classList.remove('justify-start', 'bg-gray-100', 'dark:bg-gray-700');
        } else {
            messageElement.innerHTML = `
                ${iconHtml}
                <div class="flex-1 min-w-0 prose dark:prose-invert text-left" style="max-width: 100%;">
                    ${htmlContent}
                </div>
            `;
            messageElement.classList.add('justify-start', 'bg-gray-100', 'dark:bg-gray-700');
            messageElement.classList.remove('justify-end', 'bg-green-50', 'dark:bg-gray-800');
        }
        
        chatContainer.appendChild(messageElement);
        lucide.createIcons();
        chatContainer.scrollTop = chatContainer.scrollHeight;
        
        if (text !== '...') { 
            chatHistory.push({ role: role, parts: [{ text: text }] });
            conversations[currentConversationId] = chatHistory;
            updateConversationHistory();
        }
    };

    window.copyCode = (button) => {
        const pre = button.closest('pre');
        const codeBlock = pre.querySelector('code');
        const textToCopy = codeBlock.innerText;
        navigator.clipboard.writeText(textToCopy).then(() => {
            button.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> Copied!';
            lucide.createIcons();
            setTimeout(() => {
                button.innerHTML = '<i data-lucide="clipboard" class="w-3 h-3"></i> Copy';
                lucide.createIcons();
            }, 2000);
        }).catch(err => {
            console.error('Could not copy text: ', err);
        });
    };

    const showTypingIndicator = () => {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) return; 
        const indicatorHtml = `
            <div id="typing-indicator" class="message p-4 rounded-xl max-w-4xl mx-auto flex gap-4 items-start bg-gray-100 dark:bg-gray-700 self-start bg-model w-full">
                <div class="p-2 rounded-full bg-gray-300 dark:bg-gray-700 text-green-500 flex-shrink-0"><i data-lucide="bot" class="w-5 h-5"></i></div>
                <div class="typing-indicator pt-4">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatContainer.insertAdjacentHTML('beforeend', indicatorHtml);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    const hideTypingIndicator = () => {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) {
            indicator.remove();
        }
    };

    const updateConversationHistory = () => {
        conversationHistory.innerHTML = '';
        const conversationIds = Object.keys(conversations).sort((a, b) => b - a);
        
        conversationIds.forEach(id => {
            const history = conversations[id];
            if (history.length > 0) {
                const firstUserMessage = history.find(msg => msg.role === 'user');
                const title = firstUserMessage ? firstUserMessage.parts[0].text.substring(0, 30) + (firstUserMessage.parts[0].text.length > 30 ? '...' : '') : 'New Session';
                
                const item = document.createElement('button');
                item.classList.add('flex', 'items-center', 'gap-2', 'p-3', 'rounded-xl', 'w-full', 'text-left', 'hover:bg-gray-300', 'dark:hover:bg-gray-700', 'transition-colors', 'btn', 'truncate');
                
                if (id === currentConversationId) {
                    item.classList.add('bg-green-600', 'hover:bg-green-700', 'text-white');
                } else {
                    item.classList.remove('bg-green-600', 'hover:bg-green-700', 'text-white');
                }

                item.dataset.id = id;
                item.title = title; 
                item.innerHTML = `<i data-lucide="message-square" class="w-4 h-4 flex-shrink-0"></i> <span class="truncate">${title}</span>`;
                item.onclick = () => loadConversation(id);
                conversationHistory.appendChild(item);
                lucide.createIcons();
            }
        });

        localStorage.setItem('conversations', JSON.stringify(conversations));
    };

    const loadConversation = (id) => {
        if (currentConversationId && conversations[currentConversationId] && chatHistory.length > 0) {
            conversations[currentConversationId] = chatHistory; 
        }
        
        currentConversationId = id;
        chatHistory = conversations[id] || [];
        chatContainer.innerHTML = '';

        chatHistory.forEach(msg => {
            addMessage(msg.role, msg.parts[0].text);
        });

        if (chatHistory.length === 0) {
            chatContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-center welcome-message">
                    <i data-lucide="lock-keyhole" class="w-16 h-16 text-green-500 mb-4"></i>
                    <h2 class="text-3xl font-bold mb-2 text-green-500">DEFCON AI - Cyber Intelligence Mode</h2>
                    <p class="text-gray-500 dark:text-gray-400">Axloqiy Kiberxavfsizlik bo'yicha cheklovsiz treningni boshlang!</p>
                </div>
            `;
            lucide.createIcons();
        }

        updateConversationHistory();
        if (window.innerWidth < 640) {
            toggleSidebar(false);
        }
    };

    const toggleTheme = () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        if (isDark) {
            themeIcon.dataset.lucide = 'moon';
            themeText.textContent = 'Dark Mode';
        } else {
            themeIcon.dataset.lucide = 'sun';
            themeText.textContent = 'Light Mode';
        }
        lucide.createIcons();
    };

    const toggleSidebar = (force) => {
        const isOpen = sidebar.classList.contains('open');
        const shouldOpen = force === undefined ? !isOpen : force;

        if (shouldOpen) {
            sidebar.classList.add('open');
            overlay.classList.add('active');
            overlay.classList.remove('opacity-0');
        } else {
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
            overlay.classList.add('opacity-0');
        }
    };

    const loadState = () => {
        const savedConversations = localStorage.getItem('conversations');
        if (savedConversations) {
            try {
                conversations = JSON.parse(savedConversations);
                const conversationIds = Object.keys(conversations).sort((a, b) => b - a);
                if (conversationIds.length > 0) {
                    loadConversation(conversationIds[0]);
                } else {
                    createNewConversation();
                }
            } catch (e) {
                conversations = {};
                createNewConversation();
            }
        } else {
            createNewConversation();
        }

        const savedTheme = localStorage.getItem('theme');
        const isDark = savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches);
        if (isDark) {
            document.documentElement.classList.add('dark');
            themeIcon.dataset.lucide = 'moon';
            themeText.textContent = 'Dark Mode';
        } else {
            document.documentElement.classList.remove('dark');
            themeIcon.dataset.lucide = 'sun';
            themeText.textContent = 'Light Mode';
        }
        lucide.createIcons();
    };

    // --- Event Listeners ---

    // Send Message Logic
    const sendMessage = () => {
        const userMessage = messageInput.value.trim();
        if (userMessage) {
            addMessage('user', userMessage);
            callGeminiAPI(userMessage);
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.rows = 1; 
        }
    };

    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Auto-resize textarea
    messageInput.addEventListener('input', () => {
        messageInput.style.height = 'auto';
        messageInput.style.height = messageInput.scrollHeight + 'px';
        if (messageInput.scrollHeight > 150) { 
             messageInput.style.overflowY = 'scroll';
        } else {
             messageInput.style.overflowY = 'hidden';
        }
    });

    // Modal Events
    closeModalBtn.addEventListener('click', () => hideModal(rateLimitModal));
    settingsBtn.addEventListener('click', () => showModal(settingsModal));
    closeSettingsBtn.addEventListener('click', () => hideModal(settingsModal));
    aboutBtn.addEventListener('click', () => showModal(aboutModal));
    closeAboutBtn.addEventListener('click', () => hideModal(aboutModal));
    sponsorsBtn.addEventListener('click', () => showModal(sponsorsModal));
    closeSponsorsBtn.addEventListener('click', () => hideModal(sponsorsModal));

    // Theme Toggle
    themeToggle.addEventListener('click', toggleTheme);
    themeToggleSettings.addEventListener('click', toggleTheme);

    // Sidebar Toggle (Mobile)
    menuToggle.addEventListener('click', () => toggleSidebar());
    overlay.addEventListener('click', () => toggleSidebar(false));

    // New Chat
    newChatBtn.addEventListener('click', createNewConversation);

    // Clear Chat
    clearChatBtn.addEventListener('click', () => {
        if (confirm("Haqiqatan ham barcha suhbatlarni o'chirib tashlamoqchimisiz?")) {
            localStorage.removeItem('conversations');
            conversations = {};
            createNewConversation();
        }
    });

    // Modallarni yopish uchun klaviatura tinglovchisi
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            const openModals = document.querySelectorAll('.modal:not(.hidden)');
            openModals.forEach(modal => hideModal(modal));
            toggleSidebar(false);
        }
    });

    // Appni yuklash (Boshlang'ich holatni chaqirish)
    loadState();
});
</script>
</body>
</html>